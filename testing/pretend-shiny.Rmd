---
title: "Pretend Shiny Inputs"
output: html_notebook
---


```{r setup}
    knitr::opts_knit$set(root.dir = normalizePath("~/Dropbox/Olivia/Conflict/school/UI/Project6/compensation-appraisal")) 
```

This document explains how the shiny app will take in inputs from the user, how we process the information, then how we report it. 

## Step 1: User Inputs 

The user will input their organization characteristics, their search/market criteria, and if they want to hard or soft match on each criteria. 

The possible organization characteristics 

- Form year (2009, 2010, ... , 2019)

- Do you qualify to file and 990EZ? (Yes or No)

- State (AL, AK, ..., WY)

- What type of location are you in? (Urban, Suburban, Rural)

- Major Group (1, 2, ..., 10). (https://nccs.urban.org/project/national-taxonomy-exempt-entities-ntee-codes)

- NTEE Code (A, ... , Z) ( https://nccs.urban.org/project/national-taxonomy-exempt-entities-ntee-codes)

- NTEE-CC Code (A01, ..., Z99) (https://nccs.urban.org/publication/irs-activity-codes)

- Are you a univeristy? (Yes or No)

- Are you a hospital? (Yes or No)

- Total Expenses (0 - Inf)

- Total Full time equivalent employees (0 - Inf)

Here is a pretend orginization: 

```{r}
#org characteristics 
org <- list(State = "CA",
            MajorGroup = 5,
            NTEE = "L", #need to add input for this
            NTEE.CC = "L01", #need to add input for this
            UNIV = FALSE,
            HOSP = FALSE,
            TotalExpense = 250000,
            TotalEmployee = 3,
            EZQual = TRUE,
            Loc = "rural"
)

```


The user then inputs their search criteria. They specify which types of organizations they want to compare themselves to and if each criteria is a hard or soft match. (Hard match is we will only consider what they have provided in that criteria and then if there are multiple options listed we will prioritize based on exact matches, and a soft match is we will prioritize organizations that meet their search criteria and exact matches). The search criteria is: 


- Form year (2009, 2010, ... , 2019)

- Do you want to consider orgs that qualify to file and 990EZ? (1- no, 2-yes, I want to include both orgs that do and do not qualify, 3 - yes, I only want to consider orgs that qualify)

- List of States (AL, AK, ..., WY)

- What type of locations do you want to consider? (Urban, Suburban, Rural)

- Major Group (1, 2, ..., 10). (https://nccs.urban.org/project/national-taxonomy-exempt-entities-ntee-codes)

- NTEE Code (A, ... , Z) ( https://nccs.urban.org/project/national-taxonomy-exempt-entities-ntee-codes)

- NTEE-CC Code (A01, ..., Z99) (https://nccs.urban.org/publication/irs-activity-codes)

- Do you want to include universities?  (1- no, 2-yes, I want to include both orgs that are and are not universities, 3 - yes, I only want to consider universities)

- Do you want to include hospitals?  (1- no, 2-yes, I want to include both orgs that are and are not hospitals, 3 - yes, I only want to consider hospitals)

- Range of Total Expenses c(min expenses, max expenses) (default is c(0,Inf))

- Range of Full Time equivalent Expenses c(min expenses, max expenses)(default is c(0,Inf))

If any criteria is a NA value, there will be no hard matching on that criteria. (This will mostly come up with NTEE and NTEE-CC Codes)

For each criteria, the user then specifies if they want a hard or soft match. If the user chooses hard match, we will filter out 

An example search criteria is below: 

```{r}
#search criteria
search <- list(FormYr = c(2018, 2019),
            State = c("CA", "NV", "NM","UT"),
            MajorGroup = 5,
            NTEE = c("J", "K", "L"),
            NTEE.CC = NA, #no hard matching on this criteria aaaa
            UNIV = 1,
            HOSP = 1,
            TotalExpense = c(0, 1000000),
            TotalEmployee = c(5, 30),
            EZQual = 2,
            Loc = c("Urban", "Suburan")
)

#True is hard match, FALSE is soft match
hard <- list(FormYr = FALSE,
             State = FALSE,
             MajorGroup = TRUE,
             NTEE = TRUE, 
             NTEE.CC = FALSE,
             UNIV = TRUE,
             HOSP = TRUE,
             TotalExpense = TRUE,
             TotalEmployee = TRUE,
             EZQual = FALSE,
             Loc = TRUE
)

```



## Step 2: Behind the Scenes computations

#### Step 2A: 

We first filter the data to match their hard search criteria using the `dat_filtering_hard` function in the func/dat-filtering-hard.R directory. 

```{r}
setwd("~/Dropbox/Olivia/Conflict/school/UI/Project6/compensation-appraisal")
source("funcs/dat-filtering-hard.R")
dat.filtered <- dat_filtering_hard(search, hard)
```

#### Step 2B:

We next allow the user to deselect organizations they do not want to include in their search. In the shiny app we will use the DT::dataTable options. 

```{r}
#say for whatever reason the user does not want to include org #10
rows.select <- c(1,2,3,4,5,6,7,8,9,11)
dat.filtered <- dat.filtered[ rows.select, ]
```

#### Step 2C: 

We then take these selected options and find the distance of each org in the search criteria to the user's org. We use the `HEOM_with_weights` function in the funcs/distance-metric.R file. 

There are 9 matching criteria: log10(Total Expenses), Total Employees, State, Major Group, NTEE, NTEE.CC, UNIV, HOSP,  and Location type. We do not match on year or EZ Qualification even though they are a filtering criteria. 

```{r}
setwd("~/Dropbox/Olivia/Conflict/school/UI/Project6/compensation-appraisal")
source("funcs/distance-metric.R")

results <- HEOM_with_weights(org, search, dat.filtered)

```
## Step 3: Suggest CEO Compensation

We then use the distance metrics to suggest a range for a "reasonable" CEO compensation. 
```{r}
hist(results$CEOCompensation, breaks = 20)
boxplot(results$CEOCompensation)
quantile(results$CEOCompensation, c(0, 10, 25, 50, 75, 90, 100)/ 100)
mean(results$CEOCompensation)

mod <- lm(CEOCompensation ~ as.factor(State) + 
            #need to have >1 factor in the results 
            #as.factor(NTEE) +  
            #as.factor(UNIV) + as.factor(HOSP) + as.factor(LocationType) +
            #as.factor(EZQual) + 
            TotalEmployee + log(TotalExpense, 10), data = results)



```

Exploring the distributions of distance metrics 

```{r}
hist(results$dist, breaks = 20)
boxplot(results$dist)
quantile(results$dist, c(0, 10, 25, 50, 75, 90, 100)/ 100)

```
