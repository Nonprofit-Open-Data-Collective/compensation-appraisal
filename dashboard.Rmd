---
title: "Nonprofit CEO Compensation Appraisal Tool"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(ggplot2)
library(dplyr)
library(kableExtra)
library(compensator)
library(DT)
library(shinyWidgets)
library(plotly)

```



Compensation Tool 
=======================================================================


Row
-----------------------------------------------------------------------

### Welcome to the Nonprofit CEO Compensation Appraisal Tool! 


Please enter the following information then click submit. 


```{r}
# Input State 
selectInput(inputId = "input.org.state",
            label = "State",
            choices = state.abb52)

# Input Location
selectInput(inputId = "input.org.location",
            label = "Location Type",
            choices = c("Metropolitan", "Rural"))

# Input Total Expenses
numericInput(inputId = "input.org.expense", 
             label = "Total Annual Expenses", 
             value = 1000000, 
             min = 1e5,
             max = 1e10)

# NTEE Input
textInput(inputId = "input.org.ntee",
          label = "NTEE Code",
          value = "A24")

# Generate Report 

actionButton(inputId = "generate",
             label = "Generate Appraisal")

appraisal <- eventReactive(input$generate, {
  
  loc <- dplyr::case_when(input$input.org.location == "Metropolitan" ~ "metro",
                          input$input.org.location == "Rural" ~ "rural")
  
  org <- compensator::get_org_values(state = input$input.org.state,
                                     location.type = loc,
                                     total.expense = input$input.org.expense,
                                      ntee = input$input.org.ntee)
  

  search.criteria <-
  list(broad.category = ifelse(org$type.org == "regular", org$broad.category, 1:12), 
       major.group = base::LETTERS,
       tens = 0:9,
       type.org = org$type.org,
       univ = org$univ,
       hosp = org$hosp,
       location.type = org$location.type,
       state = state.abb52,
       total.expense = c(0.1*org$total.expense, 10*org$total.expense) )
  
  samp <- select_sample(org = org, search.criteria = search.criteria)
  predict_salary(samp)
  
  })

renderPrint({
  # print(appraisal()[[2]])
  app <- appraisal()
  print(paste0("Your suggested salary is ", dollarize(round(app[[2]][1], 0)), " - ", dollarize(round(app[[2]][2],0)), "."))
  })




```




Detailed Appraisal
=======================================================================

### Recent Downlads

```{r}
mtcars %>%
  kable()
```


About
=======================================================================


Here is we will put the about information 


## Geo dist map

```{r picture, echo = F, fig.cap = "Map used for calculating geographic distance between two states", out.width = '100%'}
knitr::include_graphics("images/geo-dist-map.jpeg")
```



Gender Pay Gaps
=======================================================================

Inputs {.sidebar data-width=300}
----------------------------------------------------------------------

### **Filter By Location:**

```{r}
#### Inputs for Graph 

## State
shinyWidgets::pickerInput(
   inputId = "filter.gender.state",
   label = "States",
   choices = state.abb52,
   multiple = TRUE,
   selected = state.abb52,
   options = list(
     `actions-box` = TRUE,
     `deselect-all-text` = "None",
     `select-all-text` = "Select All",
     `none-selected-text` = "NA"
   )
)

## Location Type
shinyWidgets::pickerInput(
   inputId = "filter.gender.location.type",
   label = "Location Type",
   choices = c("Metropolitan" = "metro",
               "Rural" = "rural"),
   multiple = TRUE,
   selected = c("metro", "rural"),
   options = list(
     `actions-box` = TRUE,
     `deselect-all-text` = "None",
     `select-all-text` = "Select All",
     `none-selected-text` = "NA"
   )
)


```

### **Filter By Organization Characteristics:**

```{r}
## Broad Category
shinyWidgets::pickerInput(
  inputId = "filter.gender.broad.category",
  label = "Broad Category",
  choices = c("Arts, Culture, and Humanities" = 1,
              "Education" = 2,
              "Environment and Animals" = 3,
              "Health" = 4,
              "Human Services" = 5,
              "International, Foreign Affairs" = 6,
              "Public, Societal Benefit" = 7,
              "Religion Related" = 8,
              "Mutual/Membership Benefit" = 9,
              "Unknown/Unclassified"= 10,
              "University" = 11,
              "Hospital" = 12), #showing up as 1:10 and idk why
  multiple = TRUE,
  selected = 1:12,
  options = list(
    `actions-box` = TRUE,
    `deselect-all-text` = "None",
    `select-all-text` = "Select All",
      `none-selected-text` = "NA"
    )
  )


## Total Expenses
numericRangeInput("filter.gender.total.expense", 
                  "Range of Total Expenses",
                  value = c(0, Inf), #can we get commas on these values?
                  min = 0
)

## Total Employees
# numericRangeInput("filter.gender.total.employee", 
#                   "Range of Total Employees",
#                   value = c(0, Inf), #can we get commas on these values?
#                   min = 0)
```


### **Format Graph**

```{r}
shinyWidgets::pickerInput(
   inputId = "format.gender.yaxis",
   label = "Y-Axis",
   choices = c("Braod Category" = "broad.category",
               "Major Group" = "major.group"),
   multiple = FALSE,
   selected = c("broad.category")
) 


shinyWidgets::pickerInput(
   inputId = "format.gender.value",
   label = "Y-Axis",
   choices = c("Mean" = "Mean",
               "Median" = "Median"),
   multiple = FALSE,
   selected = c("Mean")
) 
```

Column
------------------------------------------------------------------

### Gender Pay Gap Graph

```{r}

#Format the Search Criteria
gender.graph.filters <- reactive({
  filter.gender.1 <- list(#form.year = 2019, #input$filter.year, 
                   state = input$filter.gender.state,
                   broad.category = input$filter.gender.broad.category,
                   location.type = input$filter.gender.location.type,
                   total.expense = input$filter.gender.total.expense
                   #total.employee = input$filter.gender.total.employee
                   )

  # A little formatting to get correct input values for `dat_filtering`
  if(length(filter.gender.1$location.type) == 2){
    filter.gender.1$location.type <- "both"
  }

  
  
  # Change null to na
  if(is.null(filter.gender.1$form.year)){filter.gender.1$form.year <- NA}
  if(is.null(filter.gender.1$state)){filter.gender.1$state <- "none"}
  if(is.null(filter.gender.1$broad.category)){filter.gender.1$broad.category <- 0}
  if(is.null(filter.gender.1$location.type)){filter.gender.1$location.type <- NA}
  if(is.null(filter.gender.1$total.expense)){filter.gender.1$total.expense <- c(-Inf, Inf)}
  if(is.null(filter.gender.1$total.employee)){filter.gender.1$total.employee <- c(0, Inf)}
  
  

  filter.gender.1

})

# Testing that the filtering criteria is what it should be
# renderPrint({
#   paste(gender.graph.filters())
# })


```



```{r}

renderPlotly({
  #yaxis options: "broad.category", 
    y.axis <-  input$format.gender.yaxis  
    
    #stat options: Median, Mean
    s <- input$format.gender.value
    
    #get filtered data from compensator package
    dat.filterd <- 
      compensator::dat_filtering(
        broad.category = as.numeric( gender.graph.filters()$broad.category),
        tens = 0:9,
        type.org = "both",
        univ = TRUE,
        hosp = TRUE,
        state = gender.graph.filters()$state,
        location.type = gender.graph.filters()$location.type,
        total.expense =  gender.graph.filters()$total.expense
      )


    #format data for plotting
    dat.plot <- 
      #get information in nonprofits for the ones that made it though filtersing
      dplyr::inner_join(dat.filterd, nonprofits, by = "EIN") %>%
      #remove unknown gender 
      dplyr::filter(gender != "U") %>%
      dplyr::select(ceo.compensation, gender, paste(y.axis)) %>%
      #get the correect yaxis value based on inputs
      dplyr::rename(Yaxis = paste(y.axis)) %>%
      #group by everything execpt ceo.compensation
      dplyr::group_by_at(vars(-ceo.compensation)) %>%
      #get the mean or median of ceo.compensation
      dplyr::summarise(
        Value =  ifelse(s == "Median", 
                        median(ceo.compensation), 
                        mean(ceo.compensation)), 
        n = n(), 
        .groups = "keep") %>%
      dplyr::ungroup()
    
    if(y.axis == "broad.category"){
      dat.plot <- dat.plot %>%
        dplyr::mutate(Yaxis = case_when(
          Yaxis == 1 ~ "Arts, Culture, and Humanities",
          Yaxis == 2 ~ "Education",
          Yaxis == 3 ~ "Environment and Animals",
          Yaxis == 4 ~ "Health",
          Yaxis == 5 ~ "Human Services",
          Yaxis == 6 ~ "International, Foreign Affairs",
          Yaxis == 7 ~ "Public, Societal Benefit",
          Yaxis == 8 ~ "Religion Related",
          Yaxis == 9 ~ "Mutual/Membership Benefit",
          Yaxis == 10 ~ "Unknown/Unclassified",
          Yaxis == 11 ~ "Hosptial",
          Yaxis == 12 ~ "University"))
    }
    
    if(y.axis == "major.group"){
      dat.plot <- dat.plot %>%
        dplyr::mutate(Yaxis = case_when(
          Yaxis == "A" ~ "Arts, Culture, and Humanities",
          Yaxis == "B" ~ "Education", 
          Yaxis == "C" ~ "Environment",
          Yaxis == "D" ~ "Animal-Related",
          Yaxis == "E" ~ "Health Care",
          Yaxis == "F" ~ "Mental Health & Crisis Intervention",
          Yaxis == "G" ~ "Voluntary Health Associations & Medical Disciplines",
          Yaxis == "H" ~ "Medical Research",
          Yaxis == "I" ~ "Crime & Legal-Related",
          Yaxis == "J" ~ "Employment",
          Yaxis == "K" ~ "Food, Agriculture & Nutrition",
          Yaxis == "L" ~ "Housing & Shelter",
          Yaxis == "M" ~ "Public Safety, Disaster Preparedness & Relief",
          Yaxis == "N" ~ "Recreation & Sports",
          Yaxis == "O" ~ "Youth Development",
          Yaxis == "P" ~ "Human Services",
          Yaxis == "Q" ~ "International, Foreign Affairs & National Security",
          Yaxis == "R" ~ "Civil Rights, Social Action & Advocacy",
          Yaxis == "S" ~ "Community Improvement & Capacity Building",
          Yaxis == "T" ~ "Philanthropy, Voluntarism & Grantmaking Foundations",
          Yaxis == "U" ~ "Science & Technology",
          Yaxis == "V" ~ "Social Science",
          Yaxis == "W" ~ "Public & Societal Benefit",
          Yaxis == "X" ~ "Religion-Related",
          Yaxis == "Y" ~ "Mutual & Membership Benefit",
          Yaxis == "Z" ~ "Unknown"))
    }
    
    
    #recode as factors
    dat.plot$gender <- as.factor(dat.plot$gender)
    dat.plot$Yaxis <- as.factor(dat.plot$Yaxis)
    
     #format
    x.label <- paste0(toupper(strsplit(s, "")[[1]][1]), 
                      paste0(strsplit(s, "")[[1]][-1], 
                             collapse = ""), 
                      collapse = "")

    #a little more formatting
    dat.diff <- dat.plot %>%
      tidyr::pivot_wider(names_from = gender, values_from = c(Value, n)) %>%
      dplyr::mutate(diff = abs(Value_F - Value_M)) %>%
      dplyr::mutate(pois = (Value_F + Value_M) / 2) %>%
      dplyr::select(c(Yaxis, pois, diff)) %>%
      base::merge(dat.plot)
  
    #make the ggplot
    p <- dat.diff %>%
      ggplot(aes(x = Value,
                 y = reorder(Yaxis,Value),
                 color = gender,
                 text = paste("Classification:", Yaxis),
                 n = n)) +
      geom_point(aes(text = paste0(s, ": ", dollarize(Value),
                                  "<br>Gender: ", gender)
                     )) +
      geom_line(aes(group = Yaxis), col = "gray" ) +
      geom_text(aes(x = pois, 
                    y = reorder(Yaxis,Value) ,
                    label = dollarize (round(diff))),
                nudge_y = 0.3,
                color = "grey",
                size = 3)+
      scale_color_manual(values=c("#9525AD", "#25AD80"), 
                         name = "Gender") +
      scale_x_continuous(labels=scales::dollar_format())+
      ggtitle(
        paste("CEO Pay by Gender by", 
              case_when(y.axis == "broad.category" ~ "Broad Category",
                        y.axis == "major.group" ~ "Major Group"),
              "from 2009 - 2019")) +
      xlab(paste(x.label, "CEO Compensation")) +
      ylab(
        paste(case_when(y.axis == "broad.category" ~ "Broad Category",
                        y.axis == "major.group" ~ "Major Group")))

    #output plotly
    ggplotly(p,
             tooltip = c( "text", "n"))  %>%
      #suppress the hover over the difference line
      style(p, hoverinfo = "none", traces = c(4))

  })


```
