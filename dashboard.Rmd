---
title: "Nonprofit CEO Compensation Appraisal Tool"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_laypout: fill
    theme:
      navbar-bg: "#3ADAC6"
runtime: shiny
---
```{css my-style, echo = FALSE}
.chart-shim {
    overflow-y: scroll;
    }
```


```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(ggplot2)
library(dplyr)
library(kableExtra)
library(compensator)
library(DT)
library(shinyWidgets)
library(plotly)
library(collapsibleTree)


ntee.codes <- read.csv("data-raw/ntee-crosswalk.csv")
ntee.values <- read.csv("data-raw/ntee-original.csv")


```



Get Appraisal 
=======================================================================


Organization Characteristics {.sidebar data-width=400}
-----------------------------------------------------------------------

### Welcome to the Nonprofit CEO Compensation Appraisal Tool! 

Please enter the following information then click submit. 


```{r simple.apprasial.inputs}

# Input State 
selectInput(inputId = "input.org.state",
            label = "State",
            choices = state.abb52)

# Input Location
selectInput(inputId = "input.org.location",
            label = "Location Type",
            choices = c("Metropolitan", "Suburban", "Town", "Rural"))

# Input Total Expenses
numericInput(inputId = "input.org.expense", 
             label = "Total Annual Expenses", 
             value = 1000000, 
             min = 1e5,
             max = 1e10)

# NTEE Input
textInput(inputId = "input.org.ntee",
          label = "NTEE Code",
          value = "A24")


## Potential help button for NTEE Code
# actionButton('help', 'Help')
# observeEvent(input$help,{
#     showModal(modalDialog(
#       title = "Help!",
#       "Information",
#       textInput('text2', 'You can also put UI elements here')
#     ))
#   })

# Generate Report 

actionButton(inputId = "generate",
             label = "Generate Appraisal")


#########################################################
### Get Compensation appraisal

org <- reactive({
  
  loc <- 
   dplyr::case_when(
     input$input.org.location == "Metropolitan" ~ "metro",
     input$input.org.location == "Rural" ~ "rural",
     input$input.org.location == "Suburban" ~ "suburban", 
     input$input.org.location == "Town" ~ "town")

  #return
  compensator::get_org_values(
    state = input$input.org.state,
    location.type = loc,
    total.expense = input$input.org.expense,
    ntee = input$input.org.ntee)
  
} )


loc_func <- function(x){
  if(x == "metro"){return(c("metro", "suburban"))}
  else if(x =="suburban"){return(c("metro", "subruban", "town"))}
  else if(x == "town"){return(c("rural", "subruban", "town"))}
  else{return(c("metro", "subruban", "town"))}
}


search.criteria <- reactive( {
  
  #return
  list(
    type.org = base::ifelse(org()$type.org == "RG", "RG", c("AA", "MT", "PA", "RP", "MS", "MM", "NS")),
    broad.category = base::ifelse(org()$type.org == "RG", org()$broad.category, NA),
    major.group = NA,
    division = NA,
    subdivision = NA,
    univ = TRUE,
    hosp = TRUE,
    location.type = loc_func(org()$location.type),
    state = state.abb52,
    total.expense = c(0.1*org()$total.expense, 10*org()$total.expense) )
  
})


appraisal <- eventReactive(input$generate, {

  samp <- select_sample(
    org = org(),
    search.criteria = search.criteria())

  #return
  predict_salary(samp)

  })

```


Row  {data-height=100}
---------------------------------------------------------------


### Apprasial Details 

```{r}
#print suggested Salary


h2(renderText({
  app <- appraisal()$salary.range

  #return
  print(
     paste0("Your suggested salary range is ",
            dollarize(round(app[1], 0)), " - ",
            dollarize(round(app[2],0)), "."))


  
  }) 
)


# read.this <- eventReactive(input$generate, {
#   #return
#   "Look through the graphs below to learn about the nonprofits we used to generate your apprasial."})
# 
# h5(renderText({
#   paste(read.this())
# }))

```



Row {.tabset}
----------------------------------------------

### CEO Compensation

```{r simple.apprasial.results}

## Histogram of CEO Compensations
plotlyOutput("simple.ceo") 
  

output$simple.ceo <- renderPlotly({

  comparison.set <- appraisal()$sample
  suggested.salary <- appraisal()$point.value
  suggested.range <- appraisal()$salary.range
  comparison.set <- as.data.frame(comparison.set)

  p <- comparison.set %>%
    #remove outliers
    dplyr::filter(!(ceo.compensation %in%
                      grDevices::boxplot.stats(comparison.set$ceo.compensation)$out) )%>%
    ggplot() + #aes(text = paste0("CEO Compensation: ", dollarize(ceo.compensation)))
    geom_histogram(aes(x = ceo.compensation),
                   bins = round(nrow(comparison.set) / 10, 0)) +
    geom_vline(xintercept  = suggested.salary, color = "red") +
    geom_vline(xintercept  = suggested.range[1], color = "blue") +
    geom_vline(xintercept  = suggested.range[2], color = "blue") +
    scale_x_continuous(labels=scales::dollar_format())+
    xlab("CEO Compensation") +
    ylab("Count") +
    ggtitle("CEO Compensation of All Nonprofits in Comparison Set",
            subtitle = paste0("The red line is your apprasial value of ",
                              dollarize(suggested.salary),
                              "."))

    #return
    ggplotly(p, tooltip =  c(""))
  })



```


### CEO Compensation vs. Total Expense

```{r}

## Compensation vs  log_10(Total Expense) by distance
plotlyOutput("simple.ceo.vs.expense")

output$simple.ceo.vs.expense <- renderPlotly({
  comparison.set <- appraisal()$sample
  comparison.set <- as.data.frame(comparison.set)

  new.obs <- data.frame(
    total.expense = input$input.org.expense,
    ceo.compensation = appraisal()$point.value,
    total.dist = 0,
    name = "Input Organization")

  p <- comparison.set %>%
  dplyr::filter(rank < 101) %>%
  ggplot(aes(text = paste0("Total Expense: ", dollarize(total.expense),
                           "<br>CEO Compensatoin: ", dollarize(ceo.compensation),
                           "<br>Total Distance: ", round(total.dist, 2),
                           "<br>Name :", name))) +
  geom_point(aes(x = log(total.expense, 10), y = ceo.compensation, cex = 1/total.dist / 100)) +
  geom_point(data = new.obs,
             aes(x = log(total.expense, 10),
                 y = ceo.compensation),
             col = "red", cex =5 ) +
  labs( x = "Log10( Total Expense )",
        y = "CEO Compensation",
        title = "CEO Compensation versus Log10(Total Expense) for the 100 closest Nonprofits",
        subtitle = "Large point are those close to the input organization,
        <br> and small points are those far from the input organization.")
  
  #return
  ggplotly(p, tooltip = "text")

})
```


### Nonprofit Data

```{r}

DT::renderDataTable(
  DT::datatable({
    comparison.set <- appraisal()$sample
    
    #return
    comparison.set
      
    },
    
    extensions = 'Buttons',
    
    options = list(
      paging = FALSE,
      searching = TRUE,
      fixedColumns = FALSE,
      autoWidth = FALSE,
      ordering = TRUE,
      dom = 'tB',
      buttons = c('copy', 'csv', 'excel')
    ),
    
    class = "display"
  ))

```

### Downloads

#### Downdload Data 


```{r}

# This button works but the button files up the entire page
downloadHandler(
    filename = function() {
      paste("myapprasial.csv", sep = "")
    },
    content = function(file) {
      write.csv(appraisal()$sample, file, row.names = FALSE)
    }
)

```


#### Download Report



```{r}

downloadHandler(
  # For PDF output, change this to "report.pdf"
  filename = "report.html",
  content = function(file) {
    # Copy the report file to a temporary directory before processing it, in
    # case we don't have write permissions to the current working dir (which
    # can happen when deployed).
    tempReport <- file.path(tempdir(), "report.Rmd")
    file.copy("report-template.Rmd", tempReport, overwrite = TRUE)
    
    # Set up parameters to pass to Rmd document
    params <- list(appraisal = appraisal(),
                   org = org(),
                   search.criteria = search.criteria())
    
    # Knit the document, passing in the `params` list, and eval it in a
    # child of the global environment (this isolates the code in the document
    # from the code in this app).
    rmarkdown::render(tempReport, output_file = file,
                      params = params,
                      envir = new.env(parent = globalenv())
    )
  }
)
```



Advanced Search
=======================================================================

Columns {.tabset .tabset-fade}
------------------------------------------------------------------

### Instructions 

Welcome to do a more detailed appraisal. Here you can enter more detailed information about your organization and search criteria. 

### Step 1: Your Organization Characteristics 

```{r}

# Input State 
selectInput(inputId = "detailed.org.state",
            label = "State",
            choices = state.abb52)

# Input Location
selectInput(inputId = "detailed.org.location",
            label = "Location Type",
            choices = c("Metropolitan", "Suburban", "Small Town", "Rural"))

# Input Total Expenses
numericInput(inputId = "detailed.org.expense", 
             label = "Total Annual Expenses", 
             value = 1000000, 
             min = 1e5,
             max = 1e10)

# NTEE Input
textInput(inputId = "detailed.org.ntee",
          label = "NTEE Code",
          value = "A24")

```

### Step 2: Search Criteria 


```{r}
##regular/specialty
pickerInput("detailed.search.rs",
            "Whay types of organizations do you want to include in your search?", 
            choices = c("Regular" = "RG",
                        "Alliance/Advocacy Organizations" = "AA",
                        "Management and Technical Assistance " = "MT", 
                        "Professional Societies/Associations" = "PS", 
                        "Research Institutes and/or Public Policy Analysis" = "RP", 
                        "Monetary Support - Single Organization" = "MS", 
                        "Monetary Support - Multiple Organizations" = "MM", 
                        "Nonmonetary Support Not Elsewhere Classified" = "NS"),
            multiple = TRUE,
            selected = c("RG"),
            options = list(
              `actions-box` = TRUE,
              `deselect-all-text` = "None",
              `select-all-text` = "Select All",
                `none-selected-text` = "NA"
              ))


## Broad Category 
pickerInput("detailed.search.bc",
            label = htmltools::HTML("Which broad categories do you want to include in your search?"),
            choices = c("Arts, Culture & Humanities" = "ART",
                        "Education" = "EDU",
                        "Environment and Animals" = "ENV",
                        "Health" = "HEL",
                        "Human Services" = "HMS",
                        "International, Foreign Affairs" = "IFA",
                        "Public, Societal Benefit" = "PSB",
                        "Religion Related" = "REL",
                        "Mutual/Membership Benefit" = "MMB",
                        "Unknown/Unclassified"= "UNU",
                        "University" = "UNI",
                        "Hospital" = "HOS"),
            multiple = TRUE,
            selected = c("ART", "EDU", "ENV", "HEL", "HMS", "IFA", "PSB", "REL", "MMB", "UNU", "UNI", "HOS"),
            options = list(
              `actions-box` = TRUE,
              `deselect-all-text` = "None",
              `select-all-text` = "Select All",
                `none-selected-text` = "NA"
              ))


## Major Group 
# Original Major Group
mg.options <- 
  ntee.values %>% 
  dplyr::filter(nchar(ntee) == 1) %>% 
  pull(description)

pickerInput("detailed.search.mg",
            label = "Which major groups do you want to include in your serach?",
            choices = mg.options,
            multiple = TRUE,
            selected = mg.options,
            options = list(
              `actions-box` = TRUE,
              `deselect-all-text` = "None",
              `select-all-text` = "Select All",
                `none-selected-text` = "NA"
              ))

#updating major group

observe({
  bc <- input$detailed.search.bc


  ## Broad Category
  if (is.null(bc)){
     bc <- "EDU"
     chs <- "Education"
  }

  which.letters <- ntee.codes %>%
      dplyr::filter(broad.category %in% bc) %>%
      dplyr::select(major.group) %>%
      unique()

  which.mg <- ntee.values %>%
    dplyr::filter(nchar(ntee) == 1) %>%
    dplyr::filter(ntee %in% which.letters$major.group)  %>%
    dplyr::select(description) 


  chs <- which.mg$description


  ## Updates
  updatePickerInput(
    session = session,
    inputId = "detailed.search.mg",
    label = "Which major groups do you want to include in your serach?",
    choices = chs,
    selected = chs,
    options = list(
      `actions-box` = TRUE,
      `deselect-all-text` = "None",
      `select-all-text` = "Select All",
        `none-selected-text` = "NA"
      )
      )

})



pickerInput("detailed.search.state",
            label = "Which states do you want to include in your search?",
            choices = state.abb52,
            multiple = TRUE,
            selected = state.abb52,
            options = list(
              `actions-box` = TRUE,
              `deselect-all-text` = "None",
              `select-all-text` = "Select All",
                `none-selected-text` = "NA"
              ))

pickerInput("detailed.search.location",
            label = "Which location types do you want to include in your search?",
            choices = c("Metropolitan" = "metro",
                        "Suburban" = "suburban",
                        "Small Town" = "town",
                        "Rural" = "rural"),
            multiple = TRUE,
            selected = c("metro", "suburban", "town", "rural"),
            options = list(
              `actions-box` = TRUE,
              `deselect-all-text` = "None",
              `select-all-text` = "Select All",
                `none-selected-text` = "NA"
              ))

numericRangeInput("detailed.search.total.expenses",
                  "What range of annual total expenses do you want to include in your search?",
                  value = c(1000000, 5000000 ),
                  min = 100000)

```


### Step 3: Select Organizations for Comparison 

Click "Update Comparison Set" to update your comparison set with you inputs from Step 1 and Step 2. Then select all organizations you want to include in your analysis. You can deselect organizations you do not want. Blue is selected and gray is deselected. 


```{r}

actionButton(inputId = "detailed.update.comparison",
             label = "Update Comparison Set")

# renderText(paste(unlist(detailed.search.criteria())))


### Get Org Details 
detailed.org <- eventReactive(input$detailed.update.comparison, {
  #return
  compensator::get_org_values(
    state = input$detailed.org.state,
    location.type = 
      dplyr::case_when(input$detailed.org.location == "Metropolitan" ~ "metro", 
                       input$detailed.org.location == "Suburban" ~ "suburban",
                       input$detailed.org.location == "Small Town" ~ "town",
                       input$detailed.org.location == "Rural" ~ "rural"),
    total.expense = input$detailed.org.expense,
    ntee = input$detailed.org.ntee)
} )



### Get Search Criteria
detailed.search.criteria <- eventReactive(input$detailed.update.comparison,{

  ## Get letters for major group
  search.letters <- ntee.values %>%
    dplyr::filter(nchar(ntee) == 1,
                  description %in% input$detailed.search.mg ) %>%
    dplyr::select(ntee) %>%
    pull()


  #format search criteria
   list(broad.category = input$detailed.search.bc,
       major.group = search.letters,
       type.org = input$detailed.search.rs ,
       location.type = input$detailed.search.location,
       state = input$detailed.search.state,
       total.expense = input$detailed.search.total.expenses,
       division = NA,
       subdivision = NA,
       univ = TRUE,
       hosp = TRUE)



})




### Get Comparison Set
detailed.comparisonset <- eventReactive(input$detailed.update.comparison, {

  #return
  select_sample(org = detailed.org(), search.criteria = detailed.search.criteria())

  })

output$comparisonset = DT::renderDataTable({

  #return
  detailed.comparisonset() %>%
    dplyr::select(-c(ceo.compensation, gender))

  } , server = FALSE, selection = list(selected =1:nrow(detailed.comparisonset()))
)
DT::dataTableOutput('comparisonset')

```


### Step 4: Get Apprasial 

```{r}
actionButton(inputId = "detailed.generate",
             label = "Generate Appraisal")

detailed.appraisal <- eventReactive(input$detailed.generate, {
  
  rows <- input$comparisonset_rows_selected
  samp <- detailed.comparisonset()
  samp <- samp[rows, ]
  
  #return
  predict_salary(samp)

})

h2(renderText({
   
  app <- detailed.appraisal()$salary.range 
  
  #return 
  print(
     paste0("Your suggested salary range is ", 
            dollarize(round(app[1], 0)), " - ", 
            dollarize(round(app[2],0)), "."))
   }) 
)


```



#### Downdload Data 


```{r}


# This button works but the button files up the entire page
downloadHandler(
    filename = function() {
      paste("myapprasial.csv", sep = "")
    },
    content = function(file) {
      write.csv(detailed.appraisal()$sample, file, row.names = FALSE)
    }
)

```


#### Download Report



```{r}
downloadHandler(
  # For PDF output, change this to "report.pdf"
  filename = "report.html",
  content = function(file) {
    # Copy the report file to a temporary directory before processing it, in
    # case we don't have write permissions to the current working dir (which
    # can happen when deployed).
    tempReport <- file.path(tempdir(), "report.Rmd")
    file.copy("report-template.Rmd", tempReport, overwrite = TRUE)
    
    # Set up parameters to pass to Rmd document
    params <- list(appraisal = detailed.appraisal(),
                   org = detailed.org(),
                   search.criteria = detailed.search.criteria())
    
    # Knit the document, passing in the `params` list, and eval it in a
    # child of the global environment (this isolates the code in the document
    # from the code in this app).
    rmarkdown::render(tempReport, output_file = file,
                      params = params,
                      envir = new.env(parent = globalenv())
    )
  }
)
```



Find My NTEE Code
========================================================================


Column {data-width=500}
---------------------------------------------------------------

### Here is where we will help you learn your ntee code. 


```{r}

shinyWidgets::pickerInput(
   inputId = "ntee.rs",
   label = "Which of the following describes your nonprofit best? (most organizations are regular nonprofits)",
   choices = c("Regular Nontprofit" = "RG",
               "Alliance/Advocacy Organizations" = "AA",
               "Management and Technical Assistance" = "MT",
               "Professional Societies/Associations" = "PS",
               "Research Institutes and/or Public Policy Analysis" = "RI",
               "Monetary Support - Single Organization" = "MS",
               "Monetary Support - Multiple Organizations" = "MM",
               "Nonmonetary Support Not Elsewhere Classified (N.E.C.)" = "NS"),
   multiple = FALSE,
   selected = "RG",
   width = 450
)


```



```{r}
selectInput(
  "ntee.bc", 
   "Which of the following broad cateogires best describes your nonprofit?",
   choices = c("Arts, Culture & Humanities" = "ART",
      "Education" = "EDU",
      "Environment and Animals" = "ENV",
      "Health" = "HEL",
      "Human Services" = "HMS",
      "International, Foreign Affairs" = "IFA",
      "Public, Societal Benefit" = "PSB",
      "Religion Related" = "REL",
      "Mutual/Membership Benefit" = "MMB",
      "Unknown/Unclassified" = "UNU",
      "University" = "UNI", 
      "Hospital" = "HOS"),
   width = 450)
  
observe({
  rs <- input$ntee.rs
  
  ## regular/specality 
  if (is.null(rs))
        rs <- "REG"
  
  if(rs == "RG"){
    lab <- "Which of the following broad cateogires best describes your nonprofit?"
  }else{
    lab <- "Which of the following broad cateogires best describes the nonprofit you support?"
  }
  
  ## update 
  updateSelectInput(
    session, 
    "ntee.bc",
    lab,
    choices = c("Arts, Culture & Humanities" = "ART",
       "Education" = "EDU",
       "Environment and Animals" = "ENV",
       "Health" = "HEL",
       "Human Services" = "HMS",
       "International, Foreign Affairs" = "IFA",
       "Public, Societal Benefit" = "PSB",
       "Religion Related" = "REL",
       "Mutual/Membership Benefit" = "MMB",
       "Unknown/Unclassified" = "UNU",
       "University" = "UNI",
       "Hospital" = "HOS"),
    selected = "ART"
      )
  
})
```



```{r}
selectInput(
  "ntee.mg",
  "Which of the following major groups best describes your nonprofit?",
  choices = c("Arts, Culture & Humanities" = "A",
              "Education" = "B"),
   width = 450)


observe({
  rs <- input$ntee.rs
  bc <- input$ntee.bc

  ## Regular/specialty
  if (is.null(rs))
        rs <- "RG"

  if(rs == "regular"){
    lab <- "Which of the following major groups best describes your nonprofit?"
  }else{
    lab <- "Which of the following major groups best describes the nonprofit you support?"
  }

  ## Broad Category
  if (is.null(bc)){
     bc <- "EDU"
     chs <- "Education"
  }

  which.letter <- ntee.codes %>%
      dplyr::filter(broad.category == bc) %>%
      dplyr::select(major.group) %>%
      unique()

  which.mg <- ntee.values %>%
    dplyr::filter(nchar(ntee) == 1) %>%
    dplyr::filter(ntee %in% which.letter$major.group)  %>%
    dplyr::select(description)


  chs <- which.mg$description


  ## Updates
  updateSelectInput(
    session,
    "ntee.mg",
    lab,
    choices = chs,
    selected = chs[1]
      )

})
```


```{r}
selectInput(
  "ntee.tens",
  "Which of the following devisions best describes your nonprofit?",
  choices = c("Arts & Culture" = "2",
              "Media & Communications" = "3",
              "Visual Arts" = "4",
              "Museums" = "5",
              "Performing Arts" = "6",
              "Humanities" = "7",
              "Historical Organizations" = "8",
              "Arts Services" = "9",
              "Arts, Culture & Humanities N.E.C." = "99"),
   width = 450)


observe({
  rs <- input$ntee.rs
  bc <- input$ntee.bc
  mg <- input$ntee.mg

  ## Regular/Specality
  if (is.null(rs))
        rs <- "RG"

  if(rs == "RG"){
    lab <- "Which of the following devisions best describes your nonprofit?"
  }else{
    lab <- "Which of the following devisions best describes the nonprofit you support?"
  }

  #Broad Cateogry
  if (is.null(bc)){
     bc <- "EDU"
     chs <- "Education"
  }

  # Major Group
  if (is.null(mg)){
     bc <- "EDU"
     mg <- "Education"
     chs <- "None"
  }

  mg.letter <- ntee.values %>%
    dplyr::filter(nchar(ntee) == 1,
                  description == mg) %>%
    dplyr::select(ntee) %>%
    as.character()

  which.letter <- ntee.codes %>%
      dplyr::filter(broad.category == bc,
                    major.group == mg.letter) %>%
      dplyr::select(major.group) %>%
      unique()


  which.tens <- ntee.values %>%
    dplyr::filter(substr(ntee, 3, 3) == 0 | substr(ntee, 2, 3) == 99) %>%
    dplyr::filter(substr(ntee, 1, 1) %in% which.letter$major.group)  %>%
    dplyr::select(description)

  chs <- which.tens$description

  updateSelectInput(
    session,
    "ntee.tens",
    lab,
    choices = chs,
    selected = chs[1]
      )

})


```




```{r}
selectInput(
  "ntee.ones",
  "Which of the following subdivisions best describes your nonprofit?",
  choices = c("None of These" = "0",
              "Cultural & Ethnic Awareness" = "3",
              "Folk Arts" = "4",
              "Arts Education" = "5",
              "Arts & Humanities Councils & Agencies" = "6",
              "Community Celebrations" = "7"),
   width = 450)


observe({
  rs <- input$ntee.rs
  bc <- input$ntee.bc
  mg <- input$ntee.mg
  tens <- input$ntee.tens

  ## Regular/Specality
  if (is.null(rs))
        rs <- "RG"

  if(rs == "RG"){
    lab <- "Which of the following subdivisions best describes your nonprofit?"
  }else{
    lab <- "Which of the following subdivisions best describes the nonprofit you support?"
  }

  #Broad Cateogry
  if (is.null(bc)){
     bc <- "EDU"
     chs <- "Education"
  }

  # Major Group
  if (is.null(mg)){
     bc <- "EDU"
     mg <- "Education"
     chs <- "None"
  }

  # Tens
  if(is.null(tens)){
    bc <- "ART"
    mg <- "Arts, Culture, & Humanities"
    tens <- "Museums"
    chs <- "None"
  }

  mg.letter <- ntee.values %>%
    dplyr::filter(nchar(ntee) == 1,
                  description == mg) %>%
    dplyr::select(ntee) %>%
    as.character()

  which.letter <- ntee.codes %>%
      dplyr::filter(broad.category == bc,
                    major.group == mg.letter) %>%
      dplyr::select(major.group) %>%
      unique()


  which.tens <- ntee.values %>%
    dplyr::filter(substr(ntee, 3, 3) == 0 | substr(ntee, 2, 3) == 99) %>%
    dplyr::filter(substr(ntee, 1, 1) %in% which.letter$major.group)

  tens.place <- substr(which.tens$ntee[which(which.tens$description == tens)], 2, 2)

  which.ones <- ntee.values %>%
    dplyr::filter(substr(ntee, 1, 1) %in% which.letter$major.group)  %>%
    dplyr::filter(substr(ntee, 2, 2) %in% tens.place)

  chs <- which.ones$description

  updateSelectInput(
    session,
    "ntee.ones",
    lab,
    choices = chs,
    selected = chs[1]
      )

})




```




#### Results :


```{r}
ntee.code <- reactive({

  rs <- input$ntee.rs
  bc <- input$ntee.bc
  mg <- ntee.values %>%
    dplyr::filter(nchar(ntee) == 1) %>%
    dplyr::filter(description == input$ntee.mg ) %>%
    select(ntee) %>%
    pull()
  tens <- ntee.values %>%
    dplyr::filter(nchar(ntee) == 3,
                  substr(ntee, 3, 3) == 0) %>%
    dplyr::filter(description == input$ntee.tens ) %>%
    select(ntee) %>%
    pull() %>%
    substr(2, 2)
  ones <- ntee.values %>%
    dplyr::filter(nchar(ntee) == 3) %>%
    dplyr::filter(description == input$ntee.ones ) %>%
    select(ntee) %>%
    pull() %>%
    substr(3, 3)

  if(rs == "RG"){
    ret <- ntee.codes %>%
      dplyr::filter(type.org == rs,
                    broad.category == bc,
                    major.group == mg,
                    division.subdivision == as.numeric(paste0(tens, ones)))%>%
      dplyr::select(old.code)%>%
      pull()
  }else{
    p2 <- dplyr::case_when(rs == "AA" ~ "01", 
                           rs == "MT" ~ "02", 
                           rs == "PS" ~ "03", 
                           rs == "RP" ~ "05",
                           rs == "MS" ~ "11", 
                           rs == "MM" ~ "12", 
                           rs == "NS" ~ "19")
    ret <- paste0(mg, p2, ones, tens)
    # ret <- paste0(substr(p1, 1, 1),p2, substr(p1, 2, 3))
  }
  ret
  
})

h2(renderText(paste0("Your NTEE Code is ", ntee.code(), ".")))

```


### Explore The NTEE Code Structure 

```{r}
tags$iframe(seamless="seamless", 
               src= 'images/ntee-dendogram.html',
               width='130%', 
               height=800)

```



Methodology
=======================================================================


Here is we will put the about information 


## Geo dist map

```{r picture, echo = F, fig.cap = "Map used for calculating geographic distance between two states", out.width = '100%'}
knitr::include_graphics("images/geo-dist-map.jpeg")
```



Gender In Pay Gaps
=======================================================================

Inputs {.sidebar data-width=300}
----------------------------------------------------------------------

### **Filter By Location:**

```{r}
#### Inputs for Graph 

## State
shinyWidgets::pickerInput(
   inputId = "filter.gender.state",
   label = "States",
   choices = state.abb52,
   multiple = TRUE,
   selected = state.abb52,
   options = list(
     `actions-box` = TRUE,
     `deselect-all-text` = "None",
     `select-all-text` = "Select All",
     `none-selected-text` = "NA"
   )
)

## Location Type
shinyWidgets::pickerInput(
   inputId = "filter.gender.location.type",
   label = "Location Type",
   choices = c("Metropolitan" = "metro",
               "Suburban" = "suburban",
               "Small Town" = "town",
               "Rural" = "rural"),
   multiple = TRUE,
   selected = c("metro", "subruban", "town", "rural"),
   options = list(
     `actions-box` = TRUE,
     `deselect-all-text` = "None",
     `select-all-text` = "Select All",
     `none-selected-text` = "NA"
   )
)


```

### **Filter By Organization Characteristics:**

```{r}
## Broad Category
shinyWidgets::pickerInput(
  inputId = "filter.gender.broad.category",
  label = "Broad Category",
  choices = c("Arts, Culture & Humanities" = "ART",
              "Education" = "EDU",
              "Environment and Animals" = "ENV",
              "Health" = "HEL",
              "Human Services" = "HMS",
              "International, Foreign Affairs" = "IFA",
              "Public, Societal Benefit" = "PSB",
              "Religion Related" = "REL",
              "Mutual/Membership Benefit" = "MMB",
              "Unknown/Unclassified"= "UNU",
              "University" = "UNI",
              "Hospital" = "HOS"), 
  multiple = TRUE,
  selected = c("ART", "EDU", "ENV", "HEL", "HMS", "IFA", "PSB", "REL", "MMB", "UNU", "UNI", "HOS"),
  options = list(
    `actions-box` = TRUE,
    `deselect-all-text` = "None",
    `select-all-text` = "Select All",
      `none-selected-text` = "NA"
    )
  )


## Total Expenses
numericRangeInput("filter.gender.total.expense", 
                  "Range of Total Expenses",
                  value = c(0, Inf), #can we get commas on these values?
                  min = 0
)

## Total Employees
# numericRangeInput("filter.gender.total.employee", 
#                   "Range of Total Employees",
#                   value = c(0, Inf), #can we get commas on these values?
#                   min = 0)
```


### **Format Graph**

```{r}
shinyWidgets::pickerInput(
   inputId = "format.gender.yaxis",
   label = "Y-Axis",
   choices = c("Braod Category" = "broad.category",
               "Major Group" = "major.group"),
   multiple = FALSE,
   selected = c("broad.category")
   
) 


shinyWidgets::pickerInput(
   inputId = "format.gender.value",
   label = "Summary Statistic",
   choices = c("Mean" = "Mean",
               "Median" = "Median"),
   multiple = FALSE,
   selected = c("Mean")
) 
```

Column {.tabset}
------------------------------------------------------------------

### Graph




```{r}

#Format the Search Criteria
gender.graph.filters <- reactive({
  filter.gender.1 <- 
    list(
      state = input$filter.gender.state,
      broad.category = input$filter.gender.broad.category,
      location.type = input$filter.gender.location.type,
      total.expense = input$filter.gender.total.expense
      )

  # Change null to na
  if(is.null(filter.gender.1$state)){filter.gender.1$state <- "none"}
  if(is.null(filter.gender.1$broad.category)){filter.gender.1$broad.category <- NA}
  if(is.null(filter.gender.1$location.type)){filter.gender.1$location.type <- NA}
  if(is.null(filter.gender.1$total.expense)){filter.gender.1$total.expense <- c(-Inf, Inf)}

  

  filter.gender.1

})

# Testing that the filtering criteria is what it should be
# renderPrint({
#   
#   paste(head(gender.graph.filters))
# })


```

```{r}

renderPlotly({
  #yaxis options: "broad.category", 
    y.axis <-  input$format.gender.yaxis  
    
    #stat options: Median, Mean
    s <- input$format.gender.value
    
    #get filtered data from compensator package
    dat.filtered <- 
      compensator::dat_filtering(
        broad.category =  gender.graph.filters()$broad.category,
        major.group = NA,
        univ = TRUE,
        hosp = TRUE,
        state = gender.graph.filters()$state,
        location.type = gender.graph.filters()$location.type,
        total.expense =  gender.graph.filters()$total.expense
      )


    #format data for plotting
    dat.plot <- 
      dat.filtered %>%
      dplyr::select(-c("ntee", "new.code", "total.expense", "state", "location.type")) %>%
      #get information in nonprofits for the ones that made it though filtersing
      dplyr::inner_join(nonprofits, by = "EIN") %>%
      #remove unknown gender 
      dplyr::filter(gender != "U") %>%
      dplyr::select(ceo.compensation, gender, paste(y.axis)) %>%
      #get the correect yaxis value based on inputs
      dplyr::rename(Yaxis = paste(y.axis)) %>%
      #group by everything execpt ceo.compensation
      dplyr::group_by_at(vars(-ceo.compensation)) %>%
      #get the mean or median of ceo.compensation
      dplyr::summarise(
        Value =  ifelse(s == "Median", 
                        median(ceo.compensation), 
                        mean(ceo.compensation)), 
        n = n(), 
        .groups = "keep") %>%
      dplyr::ungroup()
    
    if(y.axis == "broad.category"){
      dat.plot <- dat.plot %>%
        dplyr::mutate(Yaxis = case_when(
          Yaxis == "ART" ~ "Arts, Culture & Humanities",
          Yaxis == "EDU" ~ "Education",
          Yaxis == "ENV" ~ "Environment and Animals",
          Yaxis == "HEL" ~ "Health",
          Yaxis == "HMS" ~ "Human Services",
          Yaxis == "IFA" ~ "International, Foreign Affairs",
          Yaxis == "PSB" ~ "Public, Societal Benefit",
          Yaxis == "REL" ~ "Religion Related",
          Yaxis == "MMB" ~ "Mutual/Membership Benefit",
          Yaxis == "UNU" ~ "Unknown/Unclassified",
          Yaxis == "HOS" ~ "Hosptial",
          Yaxis == "UNI" ~ "University"))
    }
    
    if(y.axis == "major.group"){
      dat.plot <- dat.plot %>%
        dplyr::mutate(Yaxis = case_when(
          Yaxis == "A" ~ "Arts, Culture & Humanities",
          Yaxis == "B" ~ "Education", 
          Yaxis == "C" ~ "Environment",
          Yaxis == "D" ~ "Animal-Related",
          Yaxis == "E" ~ "Health Care",
          Yaxis == "F" ~ "Mental Health & Crisis Intervention",
          Yaxis == "G" ~ "Voluntary Health Associations & Medical Disciplines",
          Yaxis == "H" ~ "Medical Research",
          Yaxis == "I" ~ "Crime & Legal-Related",
          Yaxis == "J" ~ "Employment",
          Yaxis == "K" ~ "Food, Agriculture & Nutrition",
          Yaxis == "L" ~ "Housing & Shelter",
          Yaxis == "M" ~ "Public Safety, Disaster Preparedness & Relief",
          Yaxis == "N" ~ "Recreation & Sports",
          Yaxis == "O" ~ "Youth Development",
          Yaxis == "P" ~ "Human Services",
          Yaxis == "Q" ~ "International, Foreign Affairs & National Security",
          Yaxis == "R" ~ "Civil Rights, Social Action & Advocacy",
          Yaxis == "S" ~ "Community Improvement & Capacity Building",
          Yaxis == "T" ~ "Philanthropy, Voluntarism & Grantmaking Foundations",
          Yaxis == "U" ~ "Science & Technology",
          Yaxis == "V" ~ "Social Science",
          Yaxis == "W" ~ "Public & Societal Benefit",
          Yaxis == "X" ~ "Religion-Related",
          Yaxis == "Y" ~ "Mutual & Membership Benefit",
          Yaxis == "Z" ~ "Unknown"))
    }
    
    
    #recode as factors
    dat.plot$gender <- as.factor(dat.plot$gender)
    dat.plot$Yaxis <- as.factor(dat.plot$Yaxis)
    
     #format
    x.label <- paste0(toupper(strsplit(s, "")[[1]][1]), 
                      paste0(strsplit(s, "")[[1]][-1], 
                             collapse = ""), 
                      collapse = "")

    #a little more formatting
    dat.diff <- dat.plot %>%
      tidyr::pivot_wider(names_from = gender, values_from = c(Value, n)) %>%
      dplyr::mutate(diff = abs(Value_F - Value_M)) %>%
      dplyr::mutate(pois = (Value_F + Value_M) / 2) %>%
      dplyr::select(c(Yaxis, pois, diff)) %>%
      base::merge(dat.plot)
  
    #make the ggplot
    p <- dat.diff %>%
      ggplot(aes(x = Value,
                 y = reorder(Yaxis,Value),
                 color = gender,
                 text = paste("Classification:", Yaxis),
                 n = n)) +
      geom_line(aes(group = Yaxis), col = "gray" ) +
      geom_point(aes(text = paste0(s, ": ", dollarize(Value),
                                  "<br>Gender: ", gender)
                     )) +
      geom_text(aes(x = pois, 
                    y = reorder(Yaxis,Value) ,
                    label = dollarize (round(diff))),
                nudge_y = 0.3,
                color = "grey",
                size = 3)+
      scale_color_manual(values=c("#9525AD", "#25AD80"), 
                         name = "Gender") +
      scale_x_continuous(labels=scales::dollar_format())+
      ggtitle(
        paste("CEO Pay by Gender by", 
              case_when(y.axis == "broad.category" ~ "Broad Category",
                        y.axis == "major.group" ~ "Major Group"),
              "from 2009 - 2019"),
        subtitle = "All values listed in 2022 U.S. dollars.") +
      xlab(paste(x.label, "CEO Compensation")) +
      ylab(
        paste(case_when(y.axis == "broad.category" ~ "Broad Category",
                        y.axis == "major.group" ~ "Major Group"))) 

    #return plotly
    ggplotly(p,
             tooltip = c( "text", "n"))  %>%
      #suppress the hover over the difference line
      style(p, hoverinfo = "none", traces = c(4))

  })


```



### Data 


```{r}
#right now this is redoing the data table above, just without the plotly, 
# i know to make this more efficent we want to not have to do this twice, 
DT::renderDataTable(
  DT::datatable(
    { y.axis <-  input$format.gender.yaxis  
    
    #stat options: Median, Mean
    s <- input$format.gender.value
    
    #get filtered data from compensator package
    dat.filterd <- 
      compensator::dat_filtering(
        broad.category = as.numeric( gender.graph.filters()$broad.category),
        type.org =NA,
        univ = TRUE,
        hosp = TRUE,
        state = gender.graph.filters()$state,
        location.type = gender.graph.filters()$location.type,
        total.expense =  gender.graph.filters()$total.expense
      )
    
    
    #format data for plotting
    dat.plot <- 
      #get information in nonprofits for the ones that made it though filtersing
      dplyr::inner_join(dat.filterd, nonprofits, by = "EIN") %>%
      #remove unknown gender 
      dplyr::filter(gender != "U") %>%
      dplyr::select(ceo.compensation, gender, paste(y.axis)) %>%
      #get the correect yaxis value based on inputs
      dplyr::rename(Yaxis = paste(y.axis)) %>%
      #group by everything execpt ceo.compensation
      dplyr::group_by_at(vars(-ceo.compensation)) %>%
      #get the mean or median of ceo.compensation
      dplyr::summarise(
        Mean =  round(mean(ceo.compensation), 2),
        Median =  round(median(ceo.compensation), 2),
        SD = round(sd(ceo.compensation),2),
        n = n(), 
        .groups = "keep") %>%
      dplyr::ungroup()%>%
      dplyr::arrange(Yaxis)  
    
    if(y.axis == "broad.category"){
      dat.plot <- dat.plot %>%
        dplyr::mutate(Yaxis = case_when(
          Yaxis == "ART" ~ "Arts, Culture & Humanities",
          Yaxis == "EDU" ~ "Education",
          Yaxis == "ENV" ~ "Environment and Animals",
          Yaxis == "HEL" ~ "Health",
          Yaxis == "HMS" ~ "Human Services",
          Yaxis == "IFA" ~ "International, Foreign Affairs",
          Yaxis == "PSB" ~ "Public, Societal Benefit",
          Yaxis == "REL" ~ "Religion Related",
          Yaxis == "MMB" ~ "Mutual/Membership Benefit",
          Yaxis == "UNU" ~ "Unknown/Unclassified",
          Yaxis == "HOS" ~ "Hosptial",
          Yaxis == "UNI" ~ "University"))
    }
    
    if(y.axis == "major.group"){
      dat.plot <- dat.plot %>%
        dplyr::mutate(Yaxis = case_when(
          Yaxis == "A" ~ "Arts, Culture & Humanities",
          Yaxis == "B" ~ "Education", 
          Yaxis == "C" ~ "Environment",
          Yaxis == "D" ~ "Animal-Related",
          Yaxis == "E" ~ "Health Care",
          Yaxis == "F" ~ "Mental Health & Crisis Intervention",
          Yaxis == "G" ~ "Voluntary Health Associations & Medical Disciplines",
          Yaxis == "H" ~ "Medical Research",
          Yaxis == "I" ~ "Crime & Legal-Related",
          Yaxis == "J" ~ "Employment",
          Yaxis == "K" ~ "Food, Agriculture & Nutrition",
          Yaxis == "L" ~ "Housing & Shelter",
          Yaxis == "M" ~ "Public Safety, Disaster Preparedness & Relief",
          Yaxis == "N" ~ "Recreation & Sports",
          Yaxis == "O" ~ "Youth Development",
          Yaxis == "P" ~ "Human Services",
          Yaxis == "Q" ~ "International, Foreign Affairs & National Security",
          Yaxis == "R" ~ "Civil Rights, Social Action & Advocacy",
          Yaxis == "S" ~ "Community Improvement & Capacity Building",
          Yaxis == "T" ~ "Philanthropy, Voluntarism & Grantmaking Foundations",
          Yaxis == "U" ~ "Science & Technology",
          Yaxis == "V" ~ "Social Science",
          Yaxis == "W" ~ "Public & Societal Benefit",
          Yaxis == "X" ~ "Religion-Related",
          Yaxis == "Y" ~ "Mutual & Membership Benefit",
          Yaxis == "Z" ~ "Unknown"))
    }
    
    
    #reutrn
    dat.plot %>%
      dplyr::rename_with(~ ifelse(y.axis == "broad.category", "BroadCategory", "MajorGroup"), starts_with("Yaxis"))
    },
    
    extensions = 'Buttons',
    options = list(
      paging = FALSE,
      searching = TRUE,
      fixedColumns = FALSE,
      autoWidth = FALSE,
      ordering = TRUE,
      dom = 'tB',
      buttons = c('copy', 'csv', 'excel')
    ),
    
    class = "display"
  ))


```


About 
===============================================================


